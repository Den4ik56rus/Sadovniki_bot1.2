# Тестирование функциональности

## Краткое описание

Руководство по тестированию всех 12 функций Sadovniki-bot: от консультаций до модерации. Включает чеклисты, примеры данных и тестовые сценарии.

## Оглавление

1. [Подготовка к тестированию](#подготовка-к-тестированию)
2. [Тестовые данные](#тестовые-данные)
3. [Чеклист тестирования](#чеклист-тестирования)
4. [Автоматические тесты](#автоматические-тесты)
5. [Связанные документы](#связанные-документы)

---

## Подготовка к тестированию

### 1. Настройка админа

```bash
# Добавьте свой Telegram ID в .env
ADMIN_IDS=YOUR_TELEGRAM_USER_ID

# Перезапустите бота
python -m src.main
```

### 2. Очистка БД (опционально)

```sql
-- Удаление тестовых данных
TRUNCATE TABLE messages, topics, moderation_queue, knowledge_base CASCADE;
```

### 3. Подготовка тестовых документов

```bash
# Создайте структуру папок
mkdir -p data/documents/клубника_летняя
mkdir -p data/documents/малина_ремонтантная

# Добавьте тестовые PDF
# (скопируйте любой PDF с информацией о культурах)
```

---

## Тестовые данные

### Seed-данные для knowledge_base

```sql
-- Вставка тестовых Q&A
INSERT INTO knowledge_base (category, subcategory, question, answer, embedding, source_type)
VALUES 
('питание растений', 'клубника летняя', 'Чем подкормить клубнику весной?', 
 'Весной клубнику подкармливают азотными удобрениями: мочевина 10-15 г/м² или аммиачная селитра.', 
 '[0.1,0.2,...]', 'manual'),
 
('посадка и уход', 'малина ремонтантная', 'Когда обрезать ремонтантную малину?', 
 'Ремонтантную малину обрезают поздней осенью, после первых заморозков, удаляя все побеги под корень.', 
 '[0.3,0.4,...]', 'manual');
```

### Seed-данные для terminology

```sql
INSERT INTO terminology (term, preferred_phrase, description) VALUES
('навоз', 'удобрения естественного происхождения', 'Тест терминологии'),
('помёт', 'органические азотные удобрения', 'Тест терминологии 2');
```

---

## Чеклист тестирования

### Feature 1: Консультации (CASE 1 - неясная культура)

**Шаги:**
1. Отправьте боту: "Как правильно подкармливать?"
2. Ожидаемо: Бот спрашивает "О какой культуре речь?"
3. Ответьте: "Про клубнику"
4. Ожидаемо: Бот спрашивает "Какая у вас клубника: летняя или ремонтантная?"
5. Ответьте: "Летняя"
6. Ожидаемо: Финальный ответ с использованием RAG

**Проверка:**
- [ ] Бот задал 2 уточняющих вопроса
- [ ] Финальный ответ учитывает "клубника летняя"
- [ ] Пара добавлена в moderation_queue

### Feature 2: Консультации (CASE 2 - общая культура)

**Шаги:**
1. Отправьте: "Когда сажать малину?"
2. Ожидаемо: Бот спрашивает "Какая у вас малина: летняя или ремонтантная?"
3. Ответьте: "Ремонтантная"
4. Ожидаемо: Финальный ответ

**Проверка:**
- [ ] Культура определена как "малина общая"
- [ ] Бот запросил уточнение типа
- [ ] Финальный ответ учитывает "малина ремонтантная"

### Feature 3: Консультации (CASE 3 - конкретная культура)

**Шаги:**
1. Отправьте: "Как ухаживать за голубикой?"
2. Ожидаемо: Сразу финальный ответ (без уточняющих вопросов)

**Проверка:**
- [ ] Бот ответил сразу
- [ ] Использован RAG-поиск
- [ ] Ответ релевантен культуре "голубика"

### Feature 4: Классификация культур

**Тесты (используйте test_culture_classification.py):**

```bash
python test_culture_classification.py
```

**Проверяемые случаи:**
```python
test_cases = [
    ("Клубника НСД", "клубника ремонтантная"),
    ("Летняя земляника", "клубника летняя"),
    ("Ремонтантная малина", "малина ремонтантная"),
    ("Чёрная смородина", "смородина"),
    ("Как сажать?", "не определено"),
]
```

**Проверка:**
- [ ] Все 12 типов культур определяются корректно
- [ ] Синонимы распознаются (НСД → ремонтантная)
- [ ] Fallback срабатывает при неоднозначности

### Feature 5: RAG-поиск

**Шаги:**
1. Добавьте тестовые данные в knowledge_base (см. выше)
2. Отправьте: "Чем подкормить клубнику весной?"
3. Проверьте логи RAG-поиска:

```
[RAG] Начинаем поиск в базе знаний
[RAG] Категория: питание растений
[RAG] Подкатегория: клубника летняя
[RAG] Найдено фрагментов: 1
  #1 [УРОВЕНЬ 1] [qa]
```

**Проверка:**
- [ ] RAG нашёл релевантные фрагменты
- [ ] Ответ использует информацию из knowledge_base
- [ ] Fallback работает (если точной культуры нет)

### Feature 6: Обработка PDF

**Шаги:**
1. Поместите PDF в `data/documents/голубика/`
2. Запустите импорт:

```bash
python scripts/import_documents.py
```

3. Проверьте БД:

```sql
SELECT filename, subcategory, total_chunks FROM documents;
SELECT COUNT(*) FROM document_chunks WHERE subcategory = 'голубика';
```

**Проверка:**
- [ ] PDF импортирован в таблицу documents
- [ ] Создано N chunks (зависит от размера PDF)
- [ ] Все chunks имеют эмбеддинги (embedding != NULL)

### Feature 7: Модерация

**Шаги (требуются права админа):**
1. Задайте вопрос боту (чтобы пара попала в очередь)
2. Отправьте `/kb_pending`
3. Ожидаемо: Список пар Q&A с кнопками
4. Нажмите "Одобрить"
5. Проверьте:

```sql
SELECT status FROM moderation_queue WHERE id = <item_id>;
-- Ожидается: approved

SELECT COUNT(*) FROM knowledge_base WHERE source_type = 'moderation';
-- Должно увеличиться на 1
```

**Проверка:**
- [ ] Очередь показывается корректно
- [ ] Одобрение добавляет в knowledge_base
- [ ] Редактирование работает (с LLM)
- [ ] Отклонение удаляет из очереди

### Feature 8: Терминология

**Шаги:**
1. Отправьте `/add_term`
2. Введите термин: "навоз"
3. Введите формулировку: "органические удобрения"
4. Отправьте боту: "Можно использовать навоз?"
5. Проверьте ответ: должен содержать "органические удобрения"

**Проверка:**
- [ ] Термин добавлен в таблицу terminology
- [ ] Промпт содержит секцию ТЕРМИНОЛОГИЯ
- [ ] LLM использует preferred_phrase в ответе

### Feature 9: Управление темами

**Шаги:**
1. Начните диалог: "Как подкормить малину?"
2. Проверьте БД:

```sql
SELECT * FROM topics WHERE status = 'open' ORDER BY created_at DESC LIMIT 1;
```

3. Продолжите диалог: "А в какое время?"
4. Проверьте: topic_id не изменился, message_count увеличился

**Проверка:**
- [ ] Тема создаётся при первом сообщении
- [ ] Культура сохраняется в topics.culture
- [ ] Followup-вопросы используют сохранённую культуру

---

## Автоматические тесты

### test_culture_classification.py

```bash
python test_culture_classification.py
```

**Что проверяет:**
- Определение всех 12 типов культур
- Обработку синонимов
- Keyword fallback

### test_culture_classification_advanced.py

```bash
python test_culture_classification_advanced.py
```

**Что проверяет:**
- Комбинированные запросы (корневой вопрос + уточнение)
- Граничные случаи (пустая строка, спецсимволы)

### Проверка компиляции

```bash
# Проверить синтаксис всех Python файлов
find src -name "*.py" | xargs python -m py_compile

# Если ошибок нет — всё OK
echo $?  # Ожидается: 0
```

---

## Связанные документы

- [SETUP.md](./SETUP.md) — Установка окружения для тестирования
- [../features/CONSULTATION_FLOW.md](../features/CONSULTATION_FLOW.md) — Детали workflow консультаций
- [../../docs/TOPIC_MANAGEMENT.md](../../docs/TOPIC_MANAGEMENT.md) — Тестовые сценарии для topics

**Версия:** 1.0  
**Дата:** 2025-12-05
