# Система классификации культур

## Краткое описание

Система автоматически определяет тип ягодной культуры из текста пользователя, используя **двухэтапный подход**: LLM-классификация с temperature=0 для детерминированности + keyword fallback для надёжности. Поддерживается **12 типов культур** с учётом деления клубники и малины на летнюю/ремонтантную/общую.

## Оглавление

1. [12 типов культур](#12-типов-культур)
2. [Архитектура классификатора](#архитектура-классификатора)
3. [Синонимы и маппинг](#синонимы-и-маппинг)
4. [Keyword fallback](#keyword-fallback)
5. [Интеграция с consultation flow](#интеграция-с-consultation-flow)
6. [Связанные документы](#связанные-документы)
7. [Файлы в проекте](#файлы-в-проекте)

---

## 12 типов культур

### Иерархия культур

```
ЯГОДНЫЕ КУЛЬТУРЫ (12 типов)
├── Клубника (3 варианта)
│   ├── клубника ремонтантная (НСД, нейтрального дня)
│   ├── клубника летняя (июньская, традиционная)
│   └── клубника общая (тип не уточнён)
│
├── Малина (3 варианта)
│   ├── малина ремонтантная
│   ├── малина летняя (обычная, традиционная)
│   └── малина общая (тип не уточнён)
│
├── Смородина (единая)
├── Голубика (единая)
├── Жимолость (единая)
├── Крыжовник (единый)
├── Ежевика (единая)
│
└── Специальные значения
    ├── общая информация (культура не указана)
    └── не определено (не удалось определить)
```

### Примеры классификации

| Вопрос | Определённая культура |
|--------|-----------------------|
| "Когда сажать клубнику НСД?" | клубника ремонтантная |
| "Как ухаживать за июньской клубникой?" | клубника летняя |
| "Чем подкормить клубнику?" | клубника общая |
| "Обрезка ремонтантной малины" | малина ремонтантная |
| "Когда собирать малину?" | малина общая |
| "Болезни смородины" | смородина |
| "Как сажать?" | не определено |

---

## Архитектура классификатора

### Функция `detect_culture_name()`

**Расположение:** src/services/llm/classification_llm.py

```python
async def detect_culture_name(text: str) -> str:
    """
    Определяет культуру из текста пользователя.
    
    Workflow:
    1. LLM-классификация (temperature=0)
    2. Маппинг синонимов
    3. Keyword fallback (если нужно)
    4. Возврат нормализованного названия
    
    Возвращает одно из 12 значений:
    - клубника ремонтантная / клубника летняя / клубника общая
    - малина ремонтантная / малина летняя / малина общая
    - смородина / голубика / жимолость / крыжовник / ежевика
    - общая информация / не определено
    """
```

### Трёхэтапный процесс

```
┌────────────────────────────────────────────────────────┐
│  Шаг 1: LLM-классификация (temperature=0)             │
├────────────────────────────────────────────────────────┤
│  Промпт: "Определи культуру из текста: {text}"         │
│  Модель: gpt-4.1-mini                                  │
│  Temperature: 0 (детерминированность)                  │
│  Ответ: "клубника нсд" / "малина" / "смородина" и т.п. │
└───────────────────────┬────────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────────┐
│  Шаг 2: Маппинг синонимов (308-382 строки)            │
├────────────────────────────────────────────────────────┤
│  "клубника нсд" → "клубника ремонтантная"             │
│  "земляника" → "клубника общая"                        │
│  "малина обычная" → "малина летняя"                    │
│  "чёрная смородина" → "смородина"                      │
└───────────────────────┬────────────────────────────────┘
                        │
                        ▼
┌────────────────────────────────────────────────────────┐
│  Шаг 3: Keyword fallback (если нужно)                  │
├────────────────────────────────────────────────────────┤
│  Если маппинг дал "общая информация" или "не определено"│
│  → поиск ключевых слов в тексте                         │
│  "клубник" → "клубника общая"                           │
│  "малин" → "малина общая"                               │
└────────────────────────────────────────────────────────┘
```

---

## Синонимы и маппинг

### Словарь синонимов

**Расположение:** src/services/llm/classification_llm.py (строки 308-382)

```python
mapping: Dict[str, str] = {
    # Клубника ремонтантная (включает НСД)
    "клубника ремонтантная": "клубника ремонтантная",
    "клубника нсд": "клубника ремонтантная",
    "клубника nsd": "клубника ремонтантная",
    "клубника нейтрального дня": "клубника ремонтантная",
    "земляника ремонтантная": "клубника ремонтантная",
    "земляника нсд": "клубника ремонтантная",
    "ремонтантная клубника": "клубника ремонтантная",
    "ремонтантная земляника": "клубника ремонтантная",

    # Клубника летняя
    "клубника летняя": "клубника летняя",
    "клубника обычная": "клубника летняя",
    "клубника традиционная": "клубника летняя",
    "клубника июньская": "клубника летняя",
    "земляника летняя": "клубника летняя",
    "июньская клубника": "клубника летняя",

    # Клубника общая
    "клубника садовая": "клубника общая",
    "земляника садовая": "клубника общая",
    "земляника": "клубника общая",
    "клубника": "клубника общая",
    "виктория": "клубника общая",

    # Малина ремонтантная
    "малина ремонтантная": "малина ремонтантная",
    "малина нсд": "малина ремонтантная",
    "ремонтантная малина": "малина ремонтантная",

    # Малина летняя
    "малина летняя": "малина летняя",
    "малина обычная": "малина летняя",
    "малина традиционная": "малина летняя",
    "летняя малина": "малина летняя",

    # Малина общая
    "малина": "малина общая",

    # Смородина (все цвета)
    "смородина": "смородина",
    "смородина черная": "смородина",
    "смородина красная": "смородина",
    "смородина белая": "смородина",
    "чёрная смородина": "смородина",
    "красная смородина": "смородина",
    "белая смородина": "смородина",

    # Остальные культуры
    "голубика": "голубика",
    "жимолость": "жимолость",
    "жимолость съедобная": "жимолость",
    "крыжовник": "крыжовник",
    "ежевика": "ежевика",

    # Специальные значения
    "общая информация": "общая информация",
    "не определено": "не определено",
}
```

### Логика маппинга

```python
# Нормализация ответа LLM
normalized = llm_response.lower().strip()

# Поиск в словаре (первое совпадение)
culture = normalized
for key, value in mapping.items():
    if key in normalized:
        culture = value
        break
```

**Почему первое совпадение:**
- Словарь упорядочен: специфичные варианты перед общими
- "клубника ремонтантная" проверяется раньше "клубника"
- "малина летняя" проверяется раньше "малина"

---

## Keyword fallback

### Функция `_keyword_fallback()`

Используется, если LLM вернул неопределённое значение.

```python
def _keyword_fallback(text: str) -> str:
    """
    Грубая классификация по ключевым словам.
    
    Используется только если:
    - LLM classification дал "не определено" или "общая информация"
    - Маппинг синонимов также не помог
    """
    t = text.lower()

    # Приоритет: ремонтантная клубника
    if ("ремонтант" in t and "клубник" in t) or "нсд" in t or "нейтр" in t:
        return "клубника ремонтантная"

    # Летняя клубника
    if ("летн" in t or "июньск" in t or "традицион" in t) and "клубник" in t:
        return "клубника летняя"

    # Клубника общая
    if any(word in t for word in ("клубник", "земляник", "виктори")):
        return "клубника общая"

    # Ремонтантная малина
    if ("ремонтант" in t and "малин" in t):
        return "малина ремонтантная"

    # Летняя малина
    if ("летн" in t or "обычн" in t) and "малин" in t:
        return "малина летняя"

    # Малина общая
    if "малин" in t:
        return "малина общая"

    # Остальные культуры
    if "смородин" in t or "чёрная" in t or "красная" in t or "белая" in t:
        return "смородина"
    if "голубик" in t:
        return "голубика"
    if "жимолост" in t:
        return "жимолость"
    if "крыжовник" in t:
        return "крыжовник"
    if "ежевик" in t:
        return "ежевика"

    return "не определено"
```

### Когда используется fallback

```python
# Только если маппинг дал неопределённый результат
if culture in ("общая информация", "не определено"):
    keyword_culture = _keyword_fallback(text)
    if keyword_culture not in ("не определено", "общая информация"):
        culture = keyword_culture
```

---

## Интеграция с consultation flow

### Вызов из handlers

```python
# src/handlers/consultation/entry.py

# Определяем культуру при новом вопросе
detected_culture = await detect_culture_name(user_text)
await set_topic_culture(topic_id, detected_culture)
culture = detected_culture

# Переход в один из трёх сценариев
if culture in ("не определено", "общая информация"):
    # CASE 1: Уточняющие вопросы без RAG
elif culture in ("клубника общая", "малина общая"):
    # CASE 2: Запрос типа (летняя/ремонтантная)
else:
    # CASE 3: Финальный ответ с RAG
```

### Комбинированная классификация

При ответе пользователя на уточняющий вопрос:

```python
# Комбинируем корневой вопрос + ответ
combined_text = f"{root_question} {clarification_answer}"
new_culture = await detect_culture_name(combined_text)

# Пример:
# root_question = "Как подкормить?"
# clarification_answer = "Малину ремонтантную"
# combined_text = "Как подкормить? Малину ремонтантную"
# new_culture = "малина ремонтантная"
```

---

## Связанные документы

- [CONSULTATION_FLOW.md](./CONSULTATION_FLOW.md) — Использование классификации в трёхсценарном workflow
- [../architecture/LLM_INTEGRATION.md](../architecture/LLM_INTEGRATION.md) — LLM с temperature=0
- [../architecture/RAG_SYSTEM.md](../architecture/RAG_SYSTEM.md) — Фильтрация по subcategory

---

## Файлы в проекте

- src/services/llm/classification_llm.py — Функция `detect_culture_name()`, словарь синонимов (строки 308-382)
- src/handlers/consultation/entry.py — Вызов классификатора

**Версия:** 1.0  
**Дата:** 2025-12-05
