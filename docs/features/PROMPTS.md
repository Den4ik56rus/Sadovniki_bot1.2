# Архитектура системы промптов

## Обзор

Система промптов разделена на модульную структуру, где каждая категория консультаций имеет свои специфичные инструкции для LLM, при этом базовые правила остаются общими.

## Структура файлов

```
src/prompts/
├── base_prompt.py              # Базовый промпт (роль, scope, формат)
├── category_prompts/           # Категорийные промпты
│   ├── __init__.py
│   ├── nutrition.py            # Питание растений
│   ├── planting_care.py        # Посадка и уход
│   ├── diseases_pests.py       # Защита от болезней и вредителей
│   ├── soil_improvement.py     # Улучшение почвы
│   └── variety_selection.py    # Подбор сортов
└── consultation_prompts.py     # Оркестратор (собирает финальный промпт)
```

## Компоненты системы

### 1. Базовый промпт (`base_prompt.py`)

**Назначение:** Определяет общие правила для всех типов консультаций.

**Содержит:**
- Роль (профессиональный агроном-консультант)
- Список поддерживаемых культур
- Ограничения scope (только ягодные культуры)
- Tone & voice (без канцелярита, без общих фраз)
- Формат работы (ЭТАП 1: уточняющие вопросы / ЭТАП 2: финальный ответ)

**Функция:** `get_base_system_prompt() -> str`

**Пример использования:**
```python
from src.prompts.base_prompt import get_base_system_prompt

base = get_base_system_prompt()
print(base)  # Базовый промпт для всех категорий
```

### 2. Категорийные промпты (`category_prompts/`)

**Назначение:** Специфичные инструкции для каждой категории консультаций.

#### 2.1 Питание растений (`nutrition.py`)

**Специфика:**
- Схемы подкормок (NPK, микроэлементы)
- Симптомы дефицита/избытка питания
- Виды удобрений и способы внесения
- Особенности питания на разных фазах развития
- Учет pH почвы

**Функция:** `get_nutrition_category_prompt(culture: str) -> str`

**Ключевые уточняющие вопросы:**
1. Культура и сорт
2. Регион/климат
3. Тип выращивания (грунт/теплица/контейнеры)
4. Возраст посадок
5. Конкретный вопрос по питанию
6. Видимые проблемы (симптомы)

#### 2.2 Посадка и уход (`planting_care.py`)

**Специфика:**
- Сроки посадки (весна/осень)
- Выбор места и подготовка почвы
- Схемы посадки
- Регулярный уход (полив, мульчирование)
- Обрезка (формирующая, санитарная)
- Подготовка к зиме

**Функция:** `get_planting_care_category_prompt(culture: str) -> str`

#### 2.3 Защита растений (`diseases_pests.py`)

**Специфика:**
- Диагностика болезней и вредителей
- Определение возбудителя
- Профилактические меры
- Химические и биологические препараты
- Сроки обработок
- Безопасность применения

**Функция:** `get_diseases_pests_category_prompt(culture: str) -> str`

#### 2.4 Улучшение почвы (`soil_improvement.py`)

**Специфика:**
- Анализ состояния почвы (тип, структура, pH)
- Требования культуры к почве
- Коррекция pH (известкование/подкисление)
- Улучшение структуры
- Повышение плодородия
- Мульчирование

**Функция:** `get_soil_improvement_category_prompt(culture: str) -> str`

**ВАЖНО:** Особый акцент на требования голубики к кислой почве (pH 4.0-5.0)

#### 2.5 Подбор сортов (`variety_selection.py`)

**Специфика:**
- Характеристики сортов (урожайность, вкус, размер ягод)
- Зимостойкость и устойчивость к болезням
- Требования к условиям выращивания
- Районирование (зоны)
- Сравнение сортов

**Функция:** `get_variety_selection_category_prompt(culture: str) -> str`

**ВАЖНО:** Обязательное различение ремонтантных и летних сортов для клубники и малины!

### 3. Оркестратор (`consultation_prompts.py`)

**Назначение:** Собирает финальный промпт из всех компонентов.

**Главная функция:**
```python
async def build_consultation_system_prompt(
    culture: str,                      # Культура (например, "малина", "голубика")
    kb_snippets: List[Dict[str, Any]], # Фрагменты из базы знаний (RAG)
    consultation_category: str = ""    # Категория ("питание растений", "посадка и уход" и т.п.)
) -> str
```

**Алгоритм сборки:**
1. Берет базовый промпт (`get_base_system_prompt()`)
2. Добавляет категорийный промпт (`_get_category_specific_prompt()`)
3. Добавляет контекст из базы знаний (`build_kb_context_snippet()`)
4. Добавляет словарь терминологии (`build_terminology_section()`)
5. Склеивает все части и возвращает финальный промпт

**Пример использования:**
```python
from src.prompts.consultation_prompts import build_consultation_system_prompt

# Для консультации по питанию малины
prompt = await build_consultation_system_prompt(
    culture="малина ремонтантная",
    kb_snippets=[],  # Фрагменты из RAG
    consultation_category="питание растений"
)
```

## Маппинг категорий

Система поддерживает следующие категории (регистронезависимо):

| Категория                | Промпт-функция                     | Алиасы                  |
|--------------------------|-----------------------------------|-------------------------|
| `питание растений`       | `get_nutrition_category_prompt`   | -                       |
| `посадка и уход`         | `get_planting_care_category_prompt` | -                     |
| `защита растений`        | `get_diseases_pests_category_prompt` | `болезни и вредители` |
| `улучшение почвы`        | `get_soil_improvement_category_prompt` | -                  |
| `подбор сортов`          | `get_variety_selection_category_prompt` | `подбор сорта`      |

## Логика работы с LLM

### Вызов из хендлера (например, `pitanie_rastenii.py`)

```python
from src.services.llm.consultation_llm import ask_consultation_llm

# Хендлер передает категорию и культуру
answer_text = await ask_consultation_llm(
    user_id=user_id,
    telegram_user_id=telegram_user_id,
    text=user_question,
    session_id=session_id,
    consultation_category="питание растений",  # ← Тип консультации
    culture="малина ремонтантная",            # ← Определенная культура
    is_first_llm_call=True,                   # ← Флаг для уточняющих вопросов
)
```

### Обработка в `consultation_llm.py`

1. Получает историю диалога из БД
2. Определяет категорию и культуру для RAG
3. Делает поиск в базе знаний (`retrieve_unified_snippets()`)
4. Вызывает `build_consultation_system_prompt()` с категорией и культурой
5. Собирает messages для LLM
6. Вызывает OpenAI API
7. Возвращает ответ

### Формирование финального промпта

```
┌─────────────────────────────────────────┐
│  БАЗОВЫЙ ПРОМПТ                         │
│  - Роль агронома                        │
│  - Список культур                       │
│  - Scope (только ягоды)                 │
│  - Формат (ЭТАП 1 / ЭТАП 2)             │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  КАТЕГОРИЙНЫЙ ПРОМПТ                    │
│  - Специфика категории                  │
│  - Ключевые уточняющие вопросы          │
│  - Особенности для данной культуры      │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  КОНТЕКСТ ИЗ БАЗЫ ЗНАНИЙ (RAG)          │
│  - УРОВЕНЬ 1: Q&A пары (высший)         │
│  - УРОВЕНЬ 2: Специфичные документы     │
│  - УРОВЕНЬ 3: Общие документы           │
└─────────────────────────────────────────┘
              ↓
┌─────────────────────────────────────────┐
│  СЛОВАРЬ ТЕРМИНОЛОГИИ                   │
│  - Предпочитаемые формулировки          │
└─────────────────────────────────────────┘
              ↓
      ФИНАЛЬНЫЙ ПРОМПТ → LLM
```

## Преимущества новой архитектуры

✅ **Модульность:** Каждая категория имеет свой промпт
✅ **Нет дублирования:** Базовые правила определены один раз
✅ **Легко расширять:** Добавить новую категорию = создать один файл
✅ **A/B тестирование:** Можно тестировать промпты для каждой категории отдельно
✅ **Специализация:** LLM получает точные инструкции для конкретной задачи
✅ **Единая точка входа:** `build_consultation_system_prompt()` - единственная функция для вызова

## Добавление новой категории

1. Создайте файл `src/prompts/category_prompts/new_category.py`:
   ```python
   def get_new_category_prompt(culture: str) -> str:
       return f"""
   СПЕЦИФИКА КАТЕГОРИИ: Новая категория

   Текущая культура: {culture}

   Твоя задача — ...

   Ключевые уточняющие вопросы:
   1. ...

   При даче рекомендаций:
   - ...
   """.strip()
   ```

2. Добавьте импорт в `src/prompts/category_prompts/__init__.py`:
   ```python
   from .new_category import get_new_category_prompt

   __all__ = [
       ...,
       "get_new_category_prompt",
   ]
   ```

3. Добавьте маппинг в `src/prompts/consultation_prompts.py`:
   ```python
   category_map = {
       ...,
       "новая категория": get_new_category_prompt,
   }
   ```

4. Готово! Теперь при вызове:
   ```python
   prompt = await build_consultation_system_prompt(
       culture="малина",
       kb_snippets=[],
       consultation_category="новая категория"
   )
   ```
   LLM получит базовый + новый категорийный промпт.

## Логика для категории "Питание растений"

Эта категория уже настроена и работает через хендлер `src/handlers/consultation/pitanie_rastenii.py`.

**Трёхэтапный процесс:**

1. **ЭТАП 1:** Пользователь пишет корневой вопрос
   - Определяется культура через `detect_culture_name()`
   - Если культура "клубника общая" или "малина общая" → задается вопрос о типе (ремонтантная/летняя)
   - Иначе → LLM вызывается с флагом `is_first_llm_call=True` и задает уточняющие вопросы

2. **ЭТАП 2 (если нужно):** Уточнение типа культуры
   - Пользователь отвечает на вопрос о типе
   - Культура переопределяется (например, "клубника общая" → "клубника ремонтантная")
   - LLM вызывается снова с флагом `is_first_llm_call=True`

3. **ЭТАП 3:** Финальный ответ
   - Пользователь отвечает на уточняющие вопросы LLM
   - Формируется полный вопрос через `build_full_question()`
   - LLM дает финальный ответ
   - Q&A отправляется в moderation queue

**Логика уточняющих вопросов встроена в промпт категории "Питание растений":**
- В базовом промпте описан формат ЭТАП 1 / ЭТАП 2
- В категорийном промпте перечислены 6 ключевых вопросов
- Флаг `is_first_llm_call=True` добавляет в сообщение инструкцию задать вопросы

## Тестирование

Запустите тест для проверки системы:

```bash
python3 test_prompts_simple.py
```

Тест проверяет:
- ✓ Базовый промпт одинаковый для всех категорий
- ✓ Категорийные промпты различаются
- ✓ Все специфичные термины присутствуют в промптах
- ✓ Структура файлов корректна

## Миграция существующих хендлеров

Для остальных категорий (посадка, болезни, почва, сорта) нужно:

1. Создать хендлеры по аналогии с `pitanie_rastenii.py`
2. Передавать `consultation_category` и `culture` в `ask_consultation_llm()`
3. Промпты уже готовы в `src/prompts/category_prompts/`

**Пример для категории "Посадка и уход":**

```python
# src/handlers/consultation/posadka_uhod.py

answer_text = await ask_consultation_llm(
    user_id=user_id,
    telegram_user_id=telegram_user_id,
    text=user_question,
    session_id=session_id,
    consultation_category="посадка и уход",  # ← Категория
    culture=culture,                         # ← Из detect_culture_name()
    is_first_llm_call=True,
)
```

LLM автоматически получит промпт из `get_planting_care_category_prompt()`.
