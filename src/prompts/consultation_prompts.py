# src/prompts/consultation_prompts.py

from typing import List, Dict, Any  # Для описания типов входных данных


def build_kb_context_snippet(snippets: List[Dict[str, Any]]) -> str:
    """
    Формирует текстовый блок с фрагментами из базы знаний для вставки в системный промт.

    Каждый фрагмент — это ответ, который уже одобрен и лежит в knowledge_base.
    """
    # Если подходящих фрагментов нет — возвращаем пустую строку
    if not snippets:
        return ""

    lines: List[str] = []

    # Перебираем каждый фрагмент
    for i, snip in enumerate(snippets, start=1):
        # Берём только ответ (answer). Вопрос и прочее можно добавить при желании.
        answer = snip["answer"]
        # Добавляем пронумерованный блок в список строк
        lines.append(f"{i}) {answer}")

    # Склеиваем все ответы через два перевода строки, чтобы было читаемо
    return "\n\n".join(lines)


def build_consultation_system_prompt(
    culture: str,                     # Культура ('strawberry', 'raspberry', 'bush' и т.п.)
    kb_snippets: List[Dict[str, Any]], # Список фрагментов базы знаний
    consultation_category: str = ""    # Тип консультации (например, "питание растений")
) -> str:
    """
    Формирует системный промт для LLM-консультации по ягодным культурам.

    Учитывает:
    - бота-консультанта по ягодным растениям,
    - запрет отвечать на вопросы не по теме,
    - структуру консультации (уточняющие вопросы → финальный ответ),
    - использование базы знаний как "каноничных" подсказок,
    - обязательное уточнение типа сорта для клубники/малины.
    """
    # Строим блок с фрагментами знаний
    kb_text_block = build_kb_context_snippet(kb_snippets)

    # Если блок непустой — оборачиваем его заголовком, иначе делаем пустую строку
    if kb_text_block:
        kb_section = (
            "Вот проверенные ответы из внутренней базы знаний. "
            "Используй их как основу, дополняй только при необходимости:\n\n"
            f"{kb_text_block}\n\n"
            "Если есть противоречия между базой знаний и твоими предположениями — "
            "отдавай приоритет базе знаний.\n"
        )
    else:
        kb_section = (
            "Подходящих готовых ответов в базе знаний нет. "
            "Отвечай на основе своих знаний, но строго с учётом ограничений ниже.\n"
        )

    # Убрали проверку "клубника общая"/"малина общая" - теперь это обрабатывается в хендлере
    variety_clarification_rule = ""

    # Основной системный промт
    system_prompt = f"""
Ты — профессиональный агроном-консультант по ягодным культурам.

Специализация:
- клубника летняя (земляника садовая традиционные сорта),
- клубника ремонтантная (земляника садовая НСД сорта),
- малина летняя,
- малина ремонтантная,
- смородина (черная, красная, белая),
- голубика,
- жимолость,
- крыжовник.

Строгие ограничения:
- Ты консультируешь ТОЛЬКО по ягодным растениям, посадке, уходу, подбору сортов, защите от вредителей и болезней, питанию и улучшению почвы.
- Если вопрос пользователя не относится к ягодным растениям (например, про дом, авто, философию, финансы, овощи, цветы), ты отвечаешь КРАТКО одной фразой в духе:
  "Я могу помочь только с консультациями по ягодным растениям и уходу за ними."
  И ничего больше.
- Не давай общие мотивационные фразы, не приглашай "задать ещё вопрос" и не используй шаблоны вроде
  "если возникнут дополнительные вопросы, обращайтесь ещё" — просто давай законченный ответ.

Формат консультации:
Ты работаешь в двухэтапном режиме:

ЭТАП 1 - Уточняющие вопросы (если нужно):
- Проанализируй вопрос пользователя и определи, какой критически важной информации не хватает для ответа.
- Задай ТОЛЬКО те уточняющие вопросы, ответы на которые отсутствуют в исходном вопросе.
- НЕ дублируй вопросы о том, что пользователь уже указал.
- Если информации достаточно для базового ответа — переходи сразу к ЭТАПУ 2.
- Все уточняющие вопросы задавай ОДНИМ сообщением, нумеруй их.
- В конце обязательно напиши: "Пожалуйста, ответьте на вопросы одним сообщением, по пунктам."

ЭТАП 2 - Финальный ответ (когда есть достаточно информации):
- Кратко формулируешь, в чём суть проблемы или задачи.
- Даёшь структурный план:
  — причины или ключевые факторы,
  — пошаговые действия (что делать сейчас, что делать позже),
  — важные нюансы и типичные ошибки,
  — варианты для разных условий (если актуально).
- Пиши по существу, избегай воды и общих слов.

Текущая культура: {culture}
Тип консультации: {consultation_category}

{variety_clarification_rule}

{kb_section}

Помни:
- Отвечай простым, понятным языком.
- Не используй канцелярит.
- Не добавляй фразы в стиле "если остались вопросы, задавайте" — просто завершай ответ.
"""

    # Убираем лишние пробелы по краям и возвращаем
    return system_prompt.strip()
